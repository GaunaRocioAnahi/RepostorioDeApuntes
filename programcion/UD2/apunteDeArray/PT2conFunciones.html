<script>
    // =======================================================
    // I. DECLARACI√ìN GLOBAL DE CONSTANTES (CONST)
    // =======================================================

    const EMOJI_CERRADO = 'üü¢';
    const EMOJI_SEGURO = '‚óªÔ∏è';
    const EMOJI_BOMBA = 'üí•';
    const TAMANO_TABLERO = 10;

    // =======================================================
    // II. DECLARACI√ìN GLOBAL DE VARIABLES DE ESTADO (LET)
    // =======================================================

    let jugadorActual;
    let juegoActivo;

    // =======================================================
    // III. DECLARACI√ìN DE FUNCIONES (UN SOLO RETURN)
    // =======================================================

    function generarTableroInterno() {
        let tablero = [];
        for (let i = 0; i < TAMANO_TABLERO; i++) {
            tablero.push(0);
        }
        const maxBombas = Math.floor(Math.random() * 5) + 1;
        let bombasColocadas = 0;
        while (bombasColocadas < maxBombas) {
            const indice = Math.floor(Math.random() * TAMANO_TABLERO);
            if (tablero[indice] === 0) {
                tablero[indice] = 1;
                bombasColocadas++;
            }
        }
        return tablero;
    }

    function crearTableroVisible() {
        let tablero = [];
        for (let i = 0; i < TAMANO_TABLERO; i++) {
            tablero.push(EMOJI_CERRADO);
        }
        return tablero;
    }

    function generarIndices(tamano) {
        let indices = [];
        for (let i = 0; i < tamano; i++) {
            indices.push(i);
        }
        const cadenaIndices = indices.join(' ');
        return cadenaIndices;
    }

    function mostrarTablero(tableroVisible) {
        const indicesNumericos = generarIndices(tableroVisible.length);

        console.log(`\n--- TABLERO ACTUAL ---`);
        console.log(`Tubos:   ${tableroVisible.join(' ')}`);
    }

    // *** FUNCI√ìN CORREGIDA: Se elimina el alert de tuber√≠a ya descubierta ***
    function obtenerIndiceValido(jugador, tableroVisible) {
        let indiceElegido;
        let jugadaValida = false;
        let entradaUsuario;

        while (!jugadaValida) {

            entradaUsuario = prompt(`[${jugador}] Elige el n√∫mero de tuber√≠a (0 a ${TAMANO_TABLERO - 1})`);

            if (entradaUsuario === null) {
                alert("Ingresa un n√∫mero v√°lido para continuar.");
            }

            indiceElegido = parseInt(entradaUsuario);

            if (
                !isNaN(indiceElegido) &&
                indiceElegido >= 0 &&
                indiceElegido < TAMANO_TABLERO
            ) {
                if (tableroVisible[indiceElegido] === EMOJI_CERRADO) {
                    console.log(` ${jugador} elige la tuber√≠a ${indiceElegido}.`);
                    jugadaValida = true;
                } else {
                    // CORRECCI√ìN: Quitamos el alert, solo mostramos en consola y se repite el prompt
                    console.log(`Tuber√≠a ${indiceElegido} ya descubierta. Intenta de nuevo.`);
                }
            } else {
                if (entradaUsuario !== null) {
                    alert(`Entrada inv√°lida. Debe ser un n√∫mero entre 0 y ${TAMANO_TABLERO - 1}.`);
                }
            }
        }

        return indiceElegido;
    }

    function evaluarJugada(indice, tableroInterno, tableroVisible) {
        let resultado;

        if (tableroInterno[indice] === 1) {
            tableroVisible[indice] = EMOJI_BOMBA;
            resultado = 'PERDIDO';
        } else {
            tableroVisible[indice] = EMOJI_SEGURO;
            resultado = 'CONTINUAR';
        }

        return resultado;
    }

    function comprobarVictoria(tableroInterno, tableroVisible) {
        let victoria = true;

        for (let i = 0; i < TAMANO_TABLERO; i++) {
            if (tableroInterno[i] === 0 && tableroVisible[i] === EMOJI_CERRADO) {
                victoria = false;
            }
        }

        return victoria;
    }

    // =======================================================
    // IV. FUNCI√ìN PRINCIPAL (TERMINACI√ìN CLARA GARANTIZADA)
    // =======================================================

    function iniciarJuego() {
        console.log("¬°Comienza la revisi√≥n de tuber√≠as de Mario y Luigi!");

        jugadorActual = 'Mario';
        juegoActivo = true;

        const tableroInterno = generarTableroInterno();
        const tableroVisible = crearTableroVisible();

        while (juegoActivo) {
            mostrarTablero(tableroVisible);
            console.log(`\nEs el turno de ${jugadorActual}.`);

            const indiceElegido = obtenerIndiceValido(jugadorActual, tableroVisible);

            const resultado = evaluarJugada(indiceElegido, tableroInterno, tableroVisible);

            if (resultado === 'PERDIDO') {
                // *** PUNTO CLAVE DE TERMINACI√ìN: Establece false y muestra una ALERTA VISIBLE ***
                mostrarTablero(tableroVisible);
                console.log(`\n*** ¬°BOOOM! ${jugadorActual} ha perdido. EL JUEGO SE DETIENE. ***`);
                juegoActivo = false;
                alert(`¬°FIN DEL JUEGO! ${jugadorActual} ha perdido. Tuber√≠a ${indiceElegido} era una bomba. üí•`);

            } else if (comprobarVictoria(tableroInterno, tableroVisible)) {
                mostrarTablero(tableroVisible);
                console.log(`\nüéâ ¬°Felicidades! HAN GANADO! üéâ`);
                juegoActivo = false;
                alert("üéâ ¬°VICTORIA! Han limpiado todas las tuber√≠as seguras. üéâ");

            } else {
                // Alternancia de Turno (solo si el juego contin√∫a)
                jugadorActual = (jugadorActual === 'Mario') ? 'Luigi' : 'Mario';
            }
        }
        console.log("\n--- JUEGO TERMINADO ---");
    }

    // =======================================================
    // V. LLAMADA DE INICIO
    // =======================================================

    iniciarJuego();
</script>